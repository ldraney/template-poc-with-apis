{% extends "base.html" %}

{% block content %}
<div x-data="{ searchTerm: '', activeTab: 'overview' }">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h2 class="text-3xl font-bold text-gray-900 mb-2">üí∞ Ingredient Pricing Dashboard</h2>
        <p class="text-gray-600 mb-4">Purchase order data from Inflow API integration</p>
        
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-blue-50 rounded-lg p-4">
                <h3 class="text-sm font-medium text-blue-700">Purchase Orders</h3>
                <p class="text-2xl font-bold text-blue-900">{{ stats.total_orders or 0 }}</p>
                <p class="text-xs text-blue-600">Total synced</p>
            </div>
            <div class="bg-green-50 rounded-lg p-4">
                <h3 class="text-sm font-medium text-green-700">Vendors</h3>
                <p class="text-2xl font-bold text-green-900">{{ stats.total_vendors or 0 }}</p>
                <p class="text-xs text-green-600">Unique suppliers</p>
            </div>
            <div class="bg-purple-50 rounded-lg p-4">
                <h3 class="text-sm font-medium text-purple-700">Ingredients</h3>
                <p class="text-2xl font-bold text-purple-900">{{ stats.total_ingredients or 0 }}</p>
                <p class="text-xs text-purple-600">Cost tracked</p>
            </div>
            <div class="bg-orange-50 rounded-lg p-4">
                <h3 class="text-sm font-medium text-orange-700">API Status</h3>
                <p class="text-lg font-bold text-green-900">‚úÖ Fixed</p>
                <p class="text-xs text-orange-600">Pagination working</p>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-white rounded-lg shadow-sm mb-6">
        <nav class="flex border-b border-gray-200">
            <button @click="activeTab = 'overview'" 
                    :class="activeTab === 'overview' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="py-4 px-6 border-b-2 font-medium text-sm">
                Overview
            </button>
            <button @click="activeTab = 'expensive'" 
                    :class="activeTab === 'expensive' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="py-4 px-6 border-b-2 font-medium text-sm">
                Most Expensive
            </button>
            <button @click="activeTab = 'sync'" 
                    :class="activeTab === 'sync' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="py-4 px-6 border-b-2 font-medium text-sm">
                Sync Controls
            </button>
        </nav>

        <!-- Overview Tab -->
        <div x-show="activeTab === 'overview'" class="p-6">
            <h3 class="text-lg font-semibold mb-4">üìä Pricing Intelligence</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-medium mb-2">Data Sources</h4>
                    <ul class="space-y-1 text-sm text-gray-600">
                        <li>‚úÖ Inflow API integration (fixed pagination)</li>
                        <li>‚úÖ Purchase order history analysis</li>
                        <li>‚úÖ Vendor price tracking</li>
                        <li>‚úÖ Cost trend analysis</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-medium mb-2">Capabilities</h4>
                    <ul class="space-y-1 text-sm text-gray-600">
                        <li>üìà Price trend detection (rising/falling/stable)</li>
                        <li>üí∞ Cost per kg calculations</li>
                        <li>üè™ Vendor relationship mapping</li>
                        <li>üìä Purchase history analysis</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Most Expensive Tab -->
        <div x-show="activeTab === 'expensive'" class="p-6">
            <h3 class="text-lg font-semibold mb-4">üí∏ Most Expensive Ingredients</h3>
            {% if stats.top_expensive %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ingredient</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Cost per kg</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% for ingredient in stats.top_expensive %}
                            <tr>
                                <td class="px-4 py-2 text-sm font-medium text-gray-900">
                                    {{ ingredient.name }}
                                </td>
                                <td class="px-4 py-2 text-sm text-gray-900 text-right font-mono">
                                    ${{ "%.2f"|format(ingredient.cost) }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-gray-500">No pricing data available. Run sync first.</p>
            {% endif %}
        </div>

        <!-- Sync Tab -->
        <div x-show="activeTab === 'sync'" class="p-6">
            <h3 class="text-lg font-semibold mb-4">üîÑ Data Synchronization</h3>
            <div class="space-y-4">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h4 class="text-green-800 font-medium mb-2">‚úÖ API Issues Resolved</h4>
                    <ul class="text-sm text-green-700 space-y-1">
                        <li>‚Ä¢ Pagination fixed (use 'skip' not 'offset')</li>
                        <li>‚Ä¢ Date filtering fixed (JSON format)</li>
                        <li>‚Ä¢ Full data access restored</li>
                    </ul>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="text-blue-800 font-medium mb-2">üöÄ Manual Sync Commands</h4>
                    <div class="space-y-2 text-sm">
                        <p class="text-blue-700">Run these commands in the pricing service directory:</p>
                        <code class="block bg-blue-100 p-2 rounded">cd services/pricing && python sync_inflow.py</code>
                        <code class="block bg-blue-100 p-2 rounded">python demo.py  # See live demo</code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-semibold mb-4">üîç Search Ingredient Pricing</h3>
        <div class="flex gap-4">
            <input 
                type="text" 
                x-model="searchTerm"
                name="q"
                placeholder="Search for ingredient pricing..."
                hx-get="/api/pricing/search"
                hx-target="#pricing-results"
                hx-trigger="keyup changed delay:300ms"
                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
            <button 
                hx-get="/api/pricing/search"
                hx-target="#pricing-results"
                hx-include="input[name='q']"
                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
            >
                Search
            </button>
        </div>
        
        <div id="pricing-results" class="mt-6">
            <!-- Search results will load here -->
        </div>
    </div>
</div>
{% endblock %}