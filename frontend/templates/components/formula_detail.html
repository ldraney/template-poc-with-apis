<div x-data="{ showInci: false, copied: false }" class="mt-4 pt-4 border-t border-gray-200">
    
    <!-- Ingredients Table -->
    <div class="mb-4">
        <h4 class="text-sm font-medium text-gray-700 mb-2">Ingredients</h4>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ingredient</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">INCI</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Function</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Cost/kg</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">%</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for ingredient in ingredients %}
                    <tr>
                        <td class="px-3 py-2 text-sm text-gray-900">
                            {{ ingredient.ingredient_name }}
                            {% if ingredient.has_inci_data %}
                            <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 ml-1">INCI</span>
                            {% endif %}
                            {% if ingredient.has_vendor_data %}
                            <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 ml-1">Vendor</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 text-sm text-gray-600">
                            {{ ingredient.inci_name or '-' }}
                        </td>
                        <td class="px-3 py-2 text-sm text-gray-600">
                            {{ ingredient.primary_function or ingredient.function or '-' }}
                        </td>
                        <td class="px-3 py-2 text-sm text-gray-600">
                            {% set pricing = pricing_data.get(ingredient.ingredient_name) %}
                            {% if pricing and pricing.last_vendor %}
                                <span class="text-blue-600">{{ pricing.last_vendor }}</span>
                            {% elif ingredient.vendor_name %}
                                <span class="text-blue-600">{{ ingredient.vendor_name }}</span>
                            {% else %}
                                <span class="text-gray-400">Unknown</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 text-sm text-right">
                            {% set pricing = pricing_data.get(ingredient.ingredient_name) %}
                            {% if pricing %}
                                <div class="flex items-center justify-end gap-1">
                                    <span class="font-medium">${{ "%.2f"|format(pricing.avg_cost_per_kg) }}</span>
                                    {% if pricing.price_trend == 'rising' %}
                                        <span class="text-red-500 text-xs">üìà</span>
                                    {% elif pricing.price_trend == 'falling' %}
                                        <span class="text-green-500 text-xs">üìâ</span>
                                    {% else %}
                                        <span class="text-gray-500 text-xs">‚û°Ô∏è</span>
                                    {% endif %}
                                </div>
                                <div class="text-xs text-gray-400">
                                    {{ pricing.purchase_count }} orders
                                </div>
                            {% else %}
                                <span class="text-gray-400 text-xs">No data</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 text-sm text-gray-600 text-right">{{ "%.2f"|format(ingredient.percentage) if ingredient.percentage else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="bg-gray-50">
                    <tr>
                        <td colspan="5" class="px-3 py-2 text-sm font-medium text-gray-700">Total</td>
                        <td class="px-3 py-2 text-sm font-medium text-gray-900 text-right">
                            {% set total = ingredients|selectattr('percentage')|sum(attribute='percentage') %}
                            {{ "%.2f"|format(total) if total else '-' }}%
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    
    <!-- Pricing section - loaded from pricing service -->
    <div hx-get="http://localhost:8005/api/pricing/{{ formula.id }}" 
         hx-trigger="revealed"
         hx-swap="innerHTML">
        <div class="htmx-indicator">
            <div class="animate-pulse bg-gray-100 rounded-lg p-6 mt-4">
                <div class="h-4 bg-gray-200 rounded w-1/4 mb-4"></div>
                <div class="h-8 bg-gray-200 rounded w-1/2"></div>
            </div>
        </div>
    </div>
    
    <!-- INCI List Section -->
    <div class="flex items-center justify-between mb-2">
        <button 
            @click="showInci = !showInci"
            class="text-sm font-medium text-blue-600 hover:text-blue-800"
        >
            <span x-text="showInci ? 'Hide' : 'Show'"></span> INCI List
            <svg x-show="!showInci" class="inline-block ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
            <svg x-show="showInci" class="inline-block ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
            </svg>
        </button>
    </div>
    
    <div x-show="showInci" x-transition class="bg-gray-50 rounded-md p-4">
        <div class="flex justify-between items-start mb-2">
            <h5 class="text-sm font-medium text-gray-700">INCI List (for client emails)</h5>
            <button 
                @click="navigator.clipboard.writeText($refs.inciText.innerText); copied = true; setTimeout(() => copied = false, 2000)"
                class="px-2 py-1 text-xs bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors"
            >
                <span x-show="!copied">Copy</span>
                <span x-show="copied" class="text-green-600">Copied!</span>
            </button>
        </div>
        <p x-ref="inciText" class="text-sm text-gray-600">
            {{ inci_list }}
        </p>
    </div>
</div>